#!/usr/bin/env ruby -w
# encoding: utf-8

require 'flog'

module Kernel
  def silence_warnings
    old_verbose, $VERBOSE = $VERBOSE, nil
    yield
  ensure
    $VERBOSE = old_verbose
  end
end

class RubyFile
  attr_reader :path, :lines, :lines_of_code, :methods

  def initialize(path)
    @path = path
    @lines = @lines_of_code = @methods = 0

    gather_statistics
  end

  def complexity
    @complexity ||= flog_total
  end

  private

  def flog_total
    silence_warnings do
      flog = Flog.new continue: true, parser: RubyParser
      flog.flog @path
      flog.total.to_f.round(1)
    end
  end

  def gather_statistics
    File.open(@path, 'r:utf-8').each_line do |line|
      @lines += 1
      @lines_of_code += 1 unless line =~ /^\s*#/ || line =~ /^\s*$/
      @methods += 1 if line =~ /^\s*def\s+[_a-z]/
    end
  end
end

puts "LINES\tLOC\tMETHODS\tCOMPLEXITY\tPATH"
puts

Dir.glob('**/*.rb').each do |path|
  file = RubyFile.new(path)

  puts "#{file.lines}\t#{file.lines_of_code}\t#{file.methods}\t#{file.complexity}\t\t#{file.path}"
  puts
end
